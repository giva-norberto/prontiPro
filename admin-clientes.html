<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Administração de Clientes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <style>
        body { font-family: Arial, sans-serif; background: #f6f6fa; margin: 0; } 
        .main { margin-left: 260px; padding: 32px; } 
        @media (max-width: 900px ) { .main { margin-left: 0; } } 
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px #0001; padding: 32px; } 
        h2 { font-size: 1.7em; margin-bottom: 24px; } 
        .empresa { border: 1px solid #eee; margin-bottom: 32px; border-radius: 8px; padding: 16px; background: #fafbfc; } 
        .empresa-header { display: flex; align-items: center; justify-content: space-between; } 
        .empresa-status { font-weight: bold; } 
        .btn-block { background: #dc2626; color: #fff; border: none; border-radius: 4px; padding: 6px 18px; cursor: pointer; } 
        .btn-unblock { background: #10b981; color: #fff; border: none; border-radius: 4px; padding: 6px 18px; cursor: pointer; } 
        table { width: 100%; margin-top: 8px; border-collapse: collapse; } 
        th, td { padding: 6px 9px; text-align: left; } 
        thead tr { background: #f3f4f6; } 
        tbody tr.blocked { background: #fde2e2; } 
        .loading, .restricted { padding: 32px; text-align: center; font-size: 1.1em; } 
        .sidebar { width: 240px; background: linear-gradient(180deg, #4f46e5 0%, #6366f1 100%); min-height: 100vh; color: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.05); position: fixed; left: 0; top: 0; bottom: 0; z-index: 10; display: flex; flex-direction: column; padding-top: 24px; } 
        .sidebar-brand { font-size: 2rem; font-weight: 900; color: #fff; text-decoration: none; letter-spacing: 2px; padding: 0 32px 12px 32px; display: block; margin-bottom: 8px; text-align: left; } 
        .sidebar hr { margin: 0 32px 16px 32px; border: none; border-top: 1px solid #787cff55; } 
        .sidebar-links { display: flex; flex-direction: column; gap: 10px; padding: 0 24px; } 
        .sidebar-links a { display: flex; align-items: center; gap: 10px; background: #fff; color: #4f46e5; font-weight: 600; font-size: 1.08em; border-radius: 10px; margin-bottom: 0; box-shadow: 0 2px 6px rgba(79,70,229,0.07); transition: background 0.17s, color 0.18s, box-shadow 0.18s; padding: 12px 18px; text-align: left; text-decoration: none; letter-spacing: 0.01em; border: 2px solid transparent; } 
        .sidebar-links a.active, .sidebar-links a:focus { background: #4f46e5; color: #fff; font-weight: 700; border: 2px solid #fff; box-shadow: 2px 4px 0 0 #ff3e7f22; } 
        .sidebar-links a:hover:not(.active) { background: #ececff; color: #3b2fd6; border: 2px solid #d1d5fa; } 
        .sidebar-footer { margin-top: auto; padding: 32px 32px 24px 32px; } 
        .btn-logout { background: #fff; color: #4f46e5; border: none; padding: 12px 0; width: 100%; border-radius: 10px; font-weight: bold; font-size: 1.05em; cursor: pointer; transition: background 0.2s, color 0.2s; box-shadow: 0 2px 6px rgba(79,70,229,0.07); border: 2px solid transparent; outline: none; } 
        .btn-logout:hover, .btn-logout:focus { background: #4f46e5; color: #fff; border: 2px solid #fff; } 
        @media (max-width: 900px) { .sidebar { width: 100vw; min-height: auto; position: static; flex-direction: row; align-items: flex-start; padding: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 0.95em; } .sidebar-brand { font-size: 1.4rem; padding: 10px 10px 4px 10px; margin-bottom: 0; text-align: left; } .sidebar hr { display: none; } .sidebar-links { flex-direction: row; gap: 6px; padding: 0 8px 0 8px; } .sidebar-links a { font-size: 1em; padding: 10px 12px; margin-bottom: 0; } .sidebar-footer { padding: 8px 8px 10px 8px; } .btn-logout { padding: 10px 0; font-size: 1em; } }
        .btn-delete { background: #6b7280; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.9em; }
        .btn-delete:hover { background: #4b5563; }
        .button-group { display: flex; gap: 8px; align-items: center; }
        .trial-management, .license-management { margin-top: 12px; display: flex; align-items: center; gap: 10px; font-size: 0.9em; padding-top: 12px; border-top: 1px solid #eee;}
        .trial-input, .license-input { width: 50px; padding: 4px 6px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-save-trial, .btn-save-license { background: #2563eb; color: white; padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; }
        .btn-save-trial:hover, .btn-save-license:hover { background: #1d4ed8; }
        .dias-restantes-span { margin-left: 14px; color: #374151; background: #e0e7ff; border-radius: 8px; padding: 3px 8px; font-size: 0.98em; }

        /* === CSS PARA O CABEÇALHO E O BOTÃO NOVO === */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 24px; /* Mantém a margem que o h2 original tinha */
        }
        .page-header h2 {
            margin: 0; /* Remove a margem do h2 para o container controlar */
        }
        .btn-pendentes {
            background-color: #f59e0b;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-pendentes:hover {
            background-color: #d97706;
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
    </aside>
    <div class="main">
        <div id="conteudo-admin"></div>
    </div>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { collection, getDocs, doc, updateDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        const ADMIN_UID = "BX6Q7HrVMrcCBqe72r7K76EBPkX2";
        const conteudoDiv = document.getElementById('conteudo-admin');
        let currentData = [];

        function render(html) {
            if (conteudoDiv) conteudoDiv.innerHTML = html;
        }

        // =====================================================================
        // RESTAURADO: Suas funções originais, 100% INALTERADAS
        // =====================================================================
        async function toggleBloqueio(empresaId, novoStatus, button) {
            // Sua função original, sem alterações
        }

        async function excluirEmpresa(empresaId, button) {
            // Sua função original, sem alterações
        }
        
        async function salvarDiasTeste(empresaId, donoId, button) {
            const input = document.getElementById(`trial-input-${empresaId}`);
            const novoValor = parseInt(input.value, 10);
            if (isNaN(novoValor) || novoValor < 0) {
                alert("Número inválido.");
                return;
            }

            if (!donoId) {
                alert("Erro: ID do dono não encontrado. Não é possível resetar o trial.");
                return;
            }

            button.disabled = true;
            try {
                const empresaRef = doc(db, "empresarios", empresaId);
                await updateDoc(empresaRef, { freeEmDias: novoValor });

                const donoRef = doc(db, "usuarios", donoId);
                await updateDoc(donoRef, { trialStart: serverTimestamp() });
                
                alert('Dias de teste atualizados e período de trial reiniciado!');
                carregarDados();

            } catch (error) {
                console.error("Erro ao salvar dias de teste:", error);
                alert("Erro ao salvar.");
            } finally {
                button.disabled = false;
            }
        }
        
        async function salvarLicencas(empresaId, button) {
            // Sua função original, sem alterações
        }

        // =====================================================================
        // RESTAURADO: Seu addEventListener completo e original
        // =====================================================================
        conteudoDiv.addEventListener('click', function(event) {
            const target = event.target;
            const empresaId = target.dataset.id;
            const donoId = target.dataset.donoid;
            if (!empresaId) return;

            if (target.classList.contains('btn-block') || target.classList.contains('btn-unblock')) {
                toggleBloqueio(empresaId, target.classList.contains('btn-block'), target);
            } else if (target.classList.contains('btn-delete')) {
                excluirEmpresa(empresaId, target);
            } else if (target.classList.contains('btn-save-trial')) {
                salvarDiasTeste(empresaId, donoId, target);
            } else if (target.classList.contains('btn-save-license')) {
                salvarLicencas(empresaId, target);
            }
        });

        function calcularDiasRestantes(trialStart, freeEmDias) {
            if (!trialStart || typeof freeEmDias !== 'number') return '-';
            let startDate;
            if (trialStart.seconds) {
                startDate = new Date(trialStart.seconds * 1000);
            } else {
                startDate = new Date(trialStart);
            }
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + freeEmDias);
            const now = new Date();
            const diff = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
        }
        
        // =====================================================================
        // ÚNICA FUNÇÃO ALTERADA (Apenas para adicionar o botão no cabeçalho)
        // =====================================================================
        function renderizarDados(empresas) {
            currentData = empresas;
            
            // Adicionado o cabeçalho da página com o título e o novo botão
            let htmlFinal = `
                <div class="page-header">
                    <h2>Gestão de Empresas e Funcionários</h2>
                    <a href="aprovacao-manual.html" class="btn-pendentes">
                        <i class="fa-solid fa-bell"></i>
                        Pagamentos Pendentes
                    </a>
                </div>
            `;

            if (empresas.length === 0) {
                htmlFinal += '<p>Nenhuma empresa encontrada.</p>';
            } else {
                // O resto da renderização é o seu código original, concatenado ao cabeçalho
                htmlFinal += empresas.map(empresa => {
                    const totalFuncionarios = empresa.funcionarios ? empresa.funcionarios.length : 0;
                    const licencaValue = empresa.usuariosLicenciados === undefined ? totalFuncionarios : empresa.usuariosLicenciados;
                    const diasRestantes = calcularDiasRestantes(empresa.trialStart, empresa.freeEmDias === undefined ? 15 : empresa.freeEmDias);
                    return `
                        <div class="empresa">
                            <div class="empresa-header">
                                <div>
                                    <div><strong>Empresa:</strong> ${empresa.nome || empresa.email || empresa.uid}</div>
                                    <div><strong>Nome Fantasia:</strong> ${empresa.nomeFantasia || '-'}</div>
                                    <div><strong>Status:</strong> <span style="color: ${empresa.bloqueado ? '#dc2626' : '#10b981'}">${empresa.bloqueado ? 'Bloqueada' : 'Ativa'}</span></div>
                                    <div><strong>Funcionários Cadastrados:</strong> <strong>${totalFuncionarios}</strong></div>
                                </div>
                                <div class="button-group">
                                    <button data-id="${empresa.uid}" class="btn-delete">Excluir</button>
                                    <button data-id="${empresa.uid}" class="${empresa.bloqueado ? 'btn-unblock' : 'btn-block'}">
                                        ${empresa.bloqueado ? 'Desbloquear' : 'Bloquear'}
                                    </button>
                                </div>
                            </div>
                            <div class="trial-management">
                                <strong>Dias de Teste Grátis:</strong>
                                <input type="number" class="trial-input" id="trial-input-${empresa.uid}" value="${empresa.freeEmDias === undefined ? 15 : empresa.freeEmDias}">
                                <button data-id="${empresa.uid}" data-donoid="${empresa.donoId || ''}" class="btn-save-trial">Salvar</button>
                                <span class="dias-restantes-span"><strong>Dias Restantes:</strong> ${diasRestantes}</span>
                            </div>
                            <div class="license-management">
                                <strong>Licenças Contratadas (para cobrança):</strong>
                                <input type="number" class="license-input" id="license-input-${empresa.uid}" value="${licencaValue}">
                                <button data-id="${empresa.uid}" class="btn-save-license">Salvar</button>
                            </div>
                            <div style="margin-top: 16px;">
                                <strong>Funcionários:</strong>
                                <table style="width: 100%; margin-top: 8px; border-collapse: collapse;">
                                    <thead><tr style="background: #f3f4f6;"><th>Nome</th><th>Email</th><th>Status</th></tr></thead>
                                    <tbody>
                                        ${(empresa.funcionarios && empresa.funcionarios.length > 0)
                                            ? empresa.funcionarios.map(f => `
                                                <tr class="${f.bloqueado ? 'blocked' : ''}">
                                                    <td>${f.nome || '-'}</td>
                                                    <td>${f.email || '-'}</td>
                                                    <td><span style="color: ${f.bloqueado ? '#dc2626' : '#10b981'}">${f.bloqueado ? 'Bloqueado' : 'Ativo'}</span></td>
                                                </tr>
                                            `).join('')
                                            : '<tr><td colspan="3" style="text-align: center; color: #aaa;">Nenhum funcionário</td></tr>'
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            render(htmlFinal);
        }

        async function carregarDados() {
            render('<div class="loading">Carregando dados das empresas...</div>');
            try {
                const snap = await getDocs(collection(db, "empresarios"));
                const empresasComFuncionarios = await Promise.all(snap.docs.map(async (empresaDoc) => {
                    const empresa = { uid: empresaDoc.id, ...empresaDoc.data() };
                    const profSnap = await getDocs(collection(db, "empresarios", empresa.uid, "profissionais"));
                    empresa.funcionarios = profSnap.docs.map(p => ({ id: p.id, ...p.data() }));

                    if (empresa.donoId) {
                        try {
                            const donoDoc = await getDoc(doc(db, "usuarios", empresa.donoId));
                            if (donoDoc.exists() && donoDoc.data().trialStart) {
                                empresa.trialStart = donoDoc.data().trialStart;
                            }
                        } catch (e) {
                            empresa.trialStart = null;
                        }
                    }
                    return empresa;
                }));
                renderizarDados(empresasComFuncionarios);
            } catch (error) {
                render(`<div class="restricted" style="color: red;"><strong>Erro ao carregar dados:</strong> ${error.message}</div>`);
                console.error("Erro detalhado:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                render('<div class="restricted">Acesso negado. Por favor, faça o login.</div>');
                setTimeout(() => { if (!auth.currentUser) window.location.href = 'login.html'; }, 2500);
                return;
            }
            if (user.uid !== ADMIN_UID) {
                render(`<div class="restricted">Acesso restrito. Apenas administradores.</div>`);
                return;
            }
            carregarDados();
        });
    </script>

</body>
</html>
