<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronti - Agenda Livre (Horários Disponíveis)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        body {
            background: #f5f7fb;
            font-family: 'Inter',sans-serif;
        }
        .main-content {
            /* margin-left: 270px; removido para retirar espaço do menu lateral */
            padding: 20px 8vw;
            max-width: 1080px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
            background: var(--card-bg,#fff);
            padding: 16px 20px;
            border-radius: 14px;
            box-shadow: var(--shadow,0 4px 20px rgba(0,0,0,0.06));
            margin-bottom: 30px;
        }
        .filtros-relatorio {
            display: flex;
            gap: 18px;
            align-items: flex-end;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--card-bg,#fff);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow,0 4px 20px rgba(0,0,0,0.06));
        }
        .item-filtro-rel { display: flex; flex-direction: column; gap: 5px; }
        .item-filtro-rel label { font-weight: 700; font-size: 0.95em; color: var(--primary-color,#4f46e5);}
        .filtro-select, .filtro-input {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1.5px solid var(--border-color,#e2e8f0);
            background: #fff;
            font-weight: 600;
        }
        .card {
            background: var(--card-bg,#fff);
            border-radius: 12px;
            box-shadow: var(--shadow,0 4px 20px rgba(0,0,0,0.06));
            padding: 20px;
            margin-bottom: 24px;
        }
        .funcionario-card {
            background: var(--card-bg,#fff);
            border-radius: 12px;
            box-shadow: var(--shadow,0 2px 8px rgba(0,0,0,0.09));
            padding: 18px;
            margin-bottom: 18px;
        }
        .funcionario-nome {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color,#4f46e5);
            margin: 0 0 10px 0;
            border-bottom: 1px solid var(--border-color,#e2e8f0);
            padding-bottom: 8px;
        }
        .grade-horarios-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .slot-horario {
            padding: 10px 12px;
            border: 1.5px solid var(--border-color,#e2e8f0);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            background: #f8fafc;
            color: var(--text-main,#1e293b);
        }
        .slot-horario.livre {
             background: #dcfce7;
             color: #166534;
             border-color: #a7f3d0;
        }
        .slot-horario.ocupado {
             background: #fee2e2;
             color: #991b1b;
             border-color: #fecaca;
        }
        .aviso-horarios {
            grid-column: 1 / -1;
            color: var(--text-secondary,#64748b);
            text-align: center;
        }
        #relatorio-placeholder {
            color: #64748b;
            font-weight: 500;
            text-align: center;
            padding: 40px;
        }
        @media(max-width:900px) {
            .main-content { /* margin-left removido */ padding: 10px 2vw; }
            .page-header { flex-direction: column; gap: 10px; padding: 10px; }
            .filtros-relatorio { padding: 10px; gap:10px;}
            .card, .funcionario-card { padding: 12px; }
            .funcionario-nome { font-size:1rem; padding-bottom:5px;}
            .grade-horarios-container { grid-template-columns: repeat(auto-fill, minmax(70px,1fr)); gap:7px;}
        }
    </style>
</head>
<body>
    <!-- Menu lateral removido -->
    <main class="main-content">
        <div class="page-header">
            <h1>Agenda Livre - Horários Disponíveis</h1>
            <a href="agenda.html" class="btn">
                <i class="fa-solid fa-arrow-left"></i>
                Voltar para Agenda
            </a>
        </div>
        <div class="filtros-relatorio">
            <div class="item-filtro-rel">
                <label for="select-profissional"><i class="fa-solid fa-user"></i> Profissional</label>
                <select id="select-profissional" class="filtro-select">
                    <option value="todos">Todos os profissionais</option>
                </select>
            </div>
            <div class="item-filtro-rel">
                <label for="input-data"><i class="fa-solid fa-calendar-day"></i> Data</label>
                <input type="date" id="input-data" class="filtro-input" />
            </div>
        </div>
        <div class="card" style="margin-bottom: 24px;">
            <h3 style="margin: 0;">
                Exibindo horários disponíveis para: 
                <strong id="data-alvo-display" style="color: var(--primary-color);">--/--/----</strong>
            </h3>
        </div>
        <div id="relatorio-container">
            <p id="relatorio-placeholder">A carregar relatório...</p>
        </div>
    </main>
    <script type="module">
        import { verificarAcesso } from './userService.js';

        let dataAlvoEl = null;
        let relatorioContainerEl = null;
        let selectProfissionalEl = null;
        let inputDataEl = null;
        let clinicaIdGlobal = null;
        let profissionaisGlobal = [];
        let agendaCompletaPorProfGlobal = {};

        // Removido o carregamento do menu lateral daqui!

        function definirDataAlvo(format) {
            if (format) {
                const offset = (new Date()).getTimezoneOffset();
                const dataFormatada = new Date(new Date(format).getTime() - (offset * 60 * 1000));
                return dataFormatada.toISOString().split('T')[0];
            }
            const agora = new Date();
            const HORA_CORTE = 17;
            if (agora.getHours() >= HORA_CORTE) agora.setDate(agora.getDate() + 1);
            const offset = agora.getTimezoneOffset();
            const dataFormatada = new Date(agora.getTime() - (offset * 60 * 1000));
            return dataFormatada.toISOString().split('T')[0];
        }

        async function carregarRelatorio() {
            relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder">A carregar relatório...</p>';
            const dataFiltro = inputDataEl.value ? inputDataEl.value : null;
            const dataAlvo = definirDataAlvo(dataFiltro);
            const [ano, mes, dia] = dataAlvo.split('-');
            dataAlvoEl.textContent = `${dia}/${mes}/${ano}`;
            try {
                const { getProfissionaisDaClinica } = await import('./firebaseService.js');
                const { getAgendaCompleta } = await import('./horarioService.js');
                profissionaisGlobal = await getProfissionaisDaClinica(clinicaIdGlobal);
                if (!profissionaisGlobal || profissionaisGlobal.length === 0) {
                    relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder">Nenhum profissional encontrado.</p>';
                    return;
                }
                selectProfissionalEl.innerHTML = '<option value="todos">Todos os profissionais</option>' +
                    profissionaisGlobal.map(prof => `<option value="${prof.id}">${prof.nome}</option>`).join('');
                agendaCompletaPorProfGlobal = {};
                const promises = profissionaisGlobal.map(async prof => {
                    agendaCompletaPorProfGlobal[prof.id] =
                        await getAgendaCompleta(dataAlvo, prof.id, 30, clinicaIdGlobal);
                });
                await Promise.all(promises);
                renderizarRelatorioFiltrado();
            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder" style="color: red;">Erro ao carregar dados.</p>';
            }
        }

        function renderizarRelatorioFiltrado() {
            const filtro = selectProfissionalEl.value;
            let profsMostrar = filtro === "todos" ? profissionaisGlobal : profissionaisGlobal.filter(p => p.id === filtro);
            if (!profsMostrar || profsMostrar.length === 0) {
                relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder">Nenhum profissional encontrado.</p>';
                return;
            }
            relatorioContainerEl.innerHTML = '';
            profsMostrar.forEach(prof => {
                const card = document.createElement('div');
                card.className = 'funcionario-card';
                const nomeEl = document.createElement('h3');
                nomeEl.className = 'funcionario-nome';
                nomeEl.textContent = prof.nome;
                card.appendChild(nomeEl);
                const gradeEl = document.createElement('div');
                gradeEl.className = 'grade-horarios-container';
                card.appendChild(gradeEl);
                const slots = agendaCompletaPorProfGlobal[prof.id];
                if (!slots || !slots.length) {
                    gradeEl.innerHTML = '<p class="aviso-horarios">Nenhum horário encontrado.</p>';
                } else {
                    slots.forEach(slot => {
                        const div = document.createElement('div');
                        div.className = 'slot-horario';
                        div.textContent = slot.inicio;
                        if (slot.livre) div.classList.add('livre');
                        else div.classList.add('ocupado');
                        gradeEl.appendChild(div);
                    });
                }
                relatorioContainerEl.appendChild(card);
            });
        }

        // Inicialização e eventos
        export async function iniciar(clinicaId) {
            clinicaIdGlobal = clinicaId;
            dataAlvoEl = document.getElementById('data-alvo-display');
            relatorioContainerEl = document.getElementById('relatorio-container');
            selectProfissionalEl = document.getElementById('select-profissional');
            inputDataEl = document.getElementById('input-data');
            selectProfissionalEl.addEventListener('change', renderizarRelatorioFiltrado);
            inputDataEl.addEventListener('change', carregarRelatorio);
            inputDataEl.value = definirDataAlvo();
            await carregarRelatorio();
        }

        async function inicializarPagina() {
            const sessao = await verificarAcesso();
            if (!sessao) return;
            let papelUsuario = sessao.papeis || [];
            if (papelUsuario.length === 0) papelUsuario.push('funcionario');
            // não carrega menu lateral aqui
            iniciar(sessao.clinicaId);
        }
        inicializarPagina();
    </script>
</body>
</html>
