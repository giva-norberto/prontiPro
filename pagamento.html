<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pagamento de Assinatura - Pronti</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container-pagamento { background: #ffffff; border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); width: 100%; max-width: 550px; }
        h1 { color: #1e293b; font-size: 2rem; margin-bottom: 10px; }
        #info-usuario { font-size: 1.1rem; color: #4f46e5; background-color: #eef2ff; padding: 10px 15px; border-radius: 8px; margin-bottom: 30px; font-weight: 600; }
        .lista-planos { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .card-plano { border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: left; cursor: pointer; transition: all 0.2s ease-in-out; }
        .card-plano:hover { border-color: #94a3b8; transform: translateY(-3px); }
        .card-plano.selecionado { border-color: #10b981; background-color: #f0fdf4; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); }
        .card-plano.desabilitado { background-color: #f8fafc; color: #cbd5e1; cursor: not-allowed; opacity: 0.7; }
        .card-plano.desabilitado:hover { border-color: #e2e8f0; transform: none; }
        .card-plano .titulo { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin: 0; }
        .card-plano.desabilitado .titulo { color: #94a3b8; }
        .card-plano .preco { font-size: 1.5rem; font-weight: 700; color: #10b981; margin: 10px 0 5px 0; }
        .card-plano .preco span { font-size: 1rem; font-weight: 400; color: #64748b; }
        .card-plano .descricao { font-size: 0.9rem; color: #64748b; margin: 0; }
        #erro-selecao { color: #dc2626; font-weight: 600; min-height: 24px; margin-top: 0; }
        .btn-pagar { width: 100%; background: #10b981; color: #fff; font-weight: 600; border: none; border-radius: 8px; padding: 15px 0; font-size: 1.2rem; cursor: pointer; transition: background 0.2s; margin-top: 10px; }
        .btn-pagar:disabled { background: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container-pagamento">
        <h1>Renove a sua Assinatura</h1>
        <h2 id="info-usuario">A carregar dados da sua empresa...</h2>
        
        <div class="lista-planos">
            </div>

        <p id="erro-selecao"></p>
        <button id="btn-pagar" class="btn-pagar" disabled>Selecione um plano</button>
    </div>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

        const getStatusUrl = 'https://getstatusempresa-uzuwj4imfa-uc.a.run.app';
        const createPreferenceUrl = 'https://createpreference-uzuwj4imfa-uc.a.run.app';

        const infoUsuarioDiv = document.getElementById('info-usuario');
        const listaPlanosContainer = document.querySelector('.lista-planos');
        const btnPagar = document.getElementById('btn-pagar');
        const erroSelecao = document.getElementById('erro-selecao');
        
        let planoSelecionado = null;
        let licencasNecessarias = 0;

        const configuracaoPrecos = {
            precoBase: 59.90,
            funcionariosInclusos: 2,
            faixasDePrecoExtra: [
                { de: 3, ate: 10, valor: 29.90 },
                { de: 11, ate: 50, valor: 24.90 },
            ]
        };
        const planosParaExibir = [2, 5, 10, 15, 20, 30, 50];

        function calcularPreco(totalFuncionarios) {
            if (totalFuncionarios <= configuracaoPrecos.funcionariosInclusos) return configuracaoPrecos.precoBase;
            let total = configuracaoPrecos.precoBase;
            for (const faixa of configuracaoPrecos.faixasDePrecoExtra) {
                const inicioDaFaixa = faixa.de;
                if (totalFuncionarios >= inicioDaFaixa) {
                    const fimDaFaixa = faixa.ate;
                    const funcionariosNestaFaixa = Math.min(totalFuncionarios, fimDaFaixa) - Math.max(configuracaoPrecos.funcionariosInclusos, inicioDaFaixa) + 1;
                    if(funcionariosNestaFaixa > 0) {
                        const funcionariosJaCobrados = Math.max(0, inicioDaFaixa - configuracaoPrecos.funcionariosInclusos -1);
                        total += (funcionariosNestaFaixa - funcionariosJaCobrados) * faixa.valor;
                    }
                }
            }
            return total;
        }

        function gerarCardsDePlano() {
            listaPlanosContainer.innerHTML = '';
            planosParaExibir.forEach(numFuncionarios => {
                const preco = calcularPreco(numFuncionarios);
                const isDesabilitado = numFuncionarios < licencasNecessarias;
                const card = document.createElement('div');
                card.className = `card-plano ${isDesabilitado ? 'desabilitado' : ''}`;
                card.dataset.funcionarios = numFuncionarios;
                card.innerHTML = `
                    <h3 class="titulo">Plano para até ${numFuncionarios} Funcionários</h3>
                    <p class="preco">${preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<span>/mês</span></p>
                    <p class="descricao">${isDesabilitado ? 'Este plano não comporta a sua equipa atual.' : 'Ideal para equipas em crescimento.'}</p>
                `;
                card.addEventListener('click', () => {
                    if (isDesabilitado) {
                        erroSelecao.textContent = `Você precisa de um plano para no mínimo ${licencasNecessarias} funcionários.`;
                        return;
                    }
                    document.querySelectorAll('.card-plano').forEach(c => c.classList.remove('selecionado'));
                    card.classList.add('selecionado');
                    planoSelecionado = { totalFuncionarios: numFuncionarios };
                    btnPagar.disabled = false;
                    btnPagar.textContent = `Pagar Assinatura (${preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})`;
                    erroSelecao.textContent = '';
                });
                listaPlanosContainer.appendChild(card);
            });
        }
        
        async function inicializarPagina(user, empresaId) {
            try {
                const response = await fetch(getStatusUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: empresaId })
                });

                if (!response.ok) {
                    // Se a resposta do servidor for um erro (ex: 403, 404), lança um erro para ser tratado pelo bloco catch.
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Empresa inválida ou assinatura expirada.');
                }

                const data = await response.json();
                licencasNecessarias = data.licencasNecessarias;
                infoUsuarioDiv.textContent = `A sua empresa precisa de ${licencasNecessarias} licenças. Selecione um plano compatível.`;
                gerarCardsDePlano();

            } catch (error) {
                console.error("Erro ao inicializar página:", error);
                
                // **INÍCIO DA CORREÇÃO DO LOOP (Conforme a sua análise)**
                // Centraliza o tratamento de todos os erros que indicam uma empresa inválida
                infoUsuarioDiv.textContent = error.message || 'Empresa inválida ou assinatura expirada. A redirecionar...';
                infoUsuarioDiv.style.color = '#dc2626';

                // 1. Limpa o ID inválido de TODOS os locais possíveis para quebrar o loop.
                sessionStorage.removeItem('empresaId');
                localStorage.removeItem('empresaAtivaId'); 

                // 2. Redireciona o utilizador para a seleção de empresa.
                setTimeout(() => { window.location.href = 'selecionar-empresa.html'; }, 3000);
                return; // Para a execução da função aqui.
                // **FIM DA CORREÇÃO DO LOOP**
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Lógica centralizada para obter o ID da empresa
                let empresaId = sessionStorage.getItem('empresaId') || localStorage.getItem('empresaAtivaId');
                
                if (!empresaId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    empresaId = urlParams.get('empresaId');
                    if(empresaId) {
                        sessionStorage.setItem('empresaId', empresaId);
                        localStorage.setItem('empresaAtivaId', empresaId);
                    }
                }

                if (!empresaId) {
                    infoUsuarioDiv.textContent = 'Nenhuma empresa selecionada. A redirecionar...';
                    infoUsuarioDiv.style.color = '#dc2626';
                    setTimeout(() => { window.location.href = 'selecionar-empresa.html'; }, 2500);
                    return;
                }
                
                inicializarPagina(user, empresaId);
            } else {
                infoUsuarioDiv.textContent = 'Você não está logado. A redirecionar para o login...';
                setTimeout(() => { window.location.href = 'login.html'; }, 2500);
            }
        });

        btnPagar.addEventListener('click', async () => {
            if (!planoSelecionado) return;
            const user = auth.currentUser;
            const empresaId = sessionStorage.getItem('empresaId') || localStorage.getItem('empresaAtivaId');
            if (!user || !empresaId) {
                erroSelecao.textContent = 'Erro: Utilizador ou empresa não identificados. Por favor, selecione a empresa novamente.';
                return;
            }
            
            btnPagar.disabled = true;
            btnPagar.textContent = 'A criar link de pagamento...';

            try {
                const response = await fetch(createPreferenceUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: empresaId,
                        planoEscolhido: { totalFuncionarios: planoSelecionado.totalFuncionarios }
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro do servidor');
                }

                const preference = await response.json();
                if (preference.init_point) {
                    window.location.href = preference.init_point;
                } else {
                    throw new Error('Não foi possível gerar o link de pagamento.');
                }
            } catch (error) {
                console.error("Erro ao pagar:", error);
                erroSelecao.textContent = error.message;
                btnPagar.disabled = false;
                btnPagar.textContent = 'Tentar Novamente';
            }
        });

    </script>
</body>
</html>
